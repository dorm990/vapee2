<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å - Vape Loyalty</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            background: #f5f5f5;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        .header {
            background: linear-gradient(135deg, #6c5ce7, #a29bfe);
            color: white;
            padding: 30px;
            border-radius: 12px;
            margin-bottom: 30px;
        }

        .header h1 {
            font-size: 32px;
            margin-bottom: 10px;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: white;
            padding: 24px;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .stat-card h3 {
            color: #666;
            font-size: 14px;
            margin-bottom: 10px;
            text-transform: uppercase;
        }

        .stat-card .value {
            font-size: 36px;
            font-weight: 700;
            color: #6c5ce7;
        }

        .section {
            background: white;
            padding: 24px;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }

        .section h2 {
            margin-bottom: 20px;
            color: #333;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #eee;
        }

        th {
            background: #f8f9fa;
            font-weight: 600;
            color: #666;
        }

        .btn {
            padding: 10px 20px;
            background: #6c5ce7;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
        }

        .btn:hover {
            background: #5f4fd1;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #999;
        }

        .error {
            background: #ff6b6b;
            color: white;
            padding: 16px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        #login-form {
            max-width: 400px;
            margin: 100px auto;
            background: white;
            padding: 40px;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
        }

        #login-form h2 {
            margin-bottom: 20px;
            color: #333;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #666;
        }

        .form-group input {
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 16px;
        }
    </style>
</head>
<body>
    <!-- –§–æ—Ä–º–∞ –≤—Ö–æ–¥–∞ -->
    <div id="login-form">
        <h2>üîê –í—Ö–æ–¥ –≤ –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å</h2>
        <div class="form-group">
            <label>Telegram ID</label>
            <input type="text" id="telegram-id" placeholder="–í–≤–µ–¥–∏—Ç–µ –≤–∞—à Telegram ID">
        </div>
        <button class="btn" onclick="login()" style="width: 100%;">–í–æ–π—Ç–∏</button>
        <p style="margin-top: 20px; text-align: center; color: #999; font-size: 14px;">
            –î–ª—è –≤—Ö–æ–¥–∞ –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã –ø—Ä–∞–≤–∞ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞
        </p>
    </div>

    <!-- –û—Å–Ω–æ–≤–Ω–æ–π –∫–æ–Ω—Ç–µ–Ω—Ç -->
    <div id="main-content" style="display: none;">
        <div class="container">
            <div class="header">
                <h1>üìä –ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å</h1>
                <p>–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø—Ä–æ–≥—Ä–∞–º–º–æ–π –ª–æ—è–ª—å–Ω–æ—Å—Ç–∏</p>
            </div>

            <div id="error-container"></div>

            <div class="stats-grid" id="stats-grid">
                <div class="stat-card">
                    <h3>–í—Å–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π</h3>
                    <div class="value" id="total-users">-</div>
                </div>
                <div class="stat-card">
                    <h3>–ú–∞–≥–∞–∑–∏–Ω–æ–≤</h3>
                    <div class="value" id="total-stores">-</div>
                </div>
                <div class="stat-card">
                    <h3>–£—Å—Ç—Ä–æ–π—Å—Ç–≤ —Å–æ–±—Ä–∞–Ω–æ</h3>
                    <div class="value" id="total-devices">-</div>
                </div>
                <div class="stat-card">
                    <h3>–í—Å–µ–≥–æ –ø–æ–∫—É–ø–æ–∫</h3>
                    <div class="value" id="total-purchases">-</div>
                </div>
            </div>

            <div class="section">
                <h2>üè™ –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ –º–∞–≥–∞–∑–∏–Ω–∞–º</h2>
                <div id="stores-stats" class="loading">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
            </div>

            <div class="section">
                <h2>üó∫Ô∏è –ì–µ–æ–≥—Ä–∞—Ñ–∏—è</h2>
                <div id="geography-stats" class="loading">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
            </div>

            <div class="section">
                <h2>üéÅ –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –Ω–∞–≥—Ä–∞–¥–∞–º–∏</h2>
                <button class="btn" style="margin-bottom: 20px;" onclick="exportReport()">üì• –≠–∫—Å–ø–æ—Ä—Ç –æ—Ç—á—ë—Ç–∞</button>
                <div id="rewards-list" class="loading">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
            </div>
        </div>
    </div>

    <script>
        const API_URL = window.location.origin + '/api';
        let authToken = null;

        async function login() {
            const telegramId = document.getElementById('telegram-id').value;
            
            if (!telegramId) {
                alert('–í–≤–µ–¥–∏—Ç–µ Telegram ID');
                return;
            }

            try {
                const response = await fetch(`${API_URL}/auth/telegram`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        telegram_id: parseInt(telegramId),
                        first_name: 'Admin',
                        last_name: 'User'
                    })
                });

                const data = await response.json();

                if (!data.success) {
                    alert('–û—à–∏–±–∫–∞ –≤—Ö–æ–¥–∞: ' + data.error);
                    return;
                }

                if (data.user.role !== 'admin') {
                    alert('–£ –≤–∞—Å –Ω–µ—Ç –ø—Ä–∞–≤ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞');
                    return;
                }

                authToken = data.token;
                document.getElementById('login-form').style.display = 'none';
                document.getElementById('main-content').style.display = 'block';
                
                loadDashboard();
            } catch (error) {
                alert('–û—à–∏–±–∫–∞ –≤—Ö–æ–¥–∞: ' + error.message);
            }
        }

        async function loadDashboard() {
            try {
                await Promise.all([
                    loadOverview(),
                    loadStoresStats(),
                    loadGeographyStats()
                ]);
            } catch (error) {
                showError('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö: ' + error.message);
            }
        }

        async function loadOverview() {
            const response = await apiRequest('/admin/statistics/overview');
            
            document.getElementById('total-users').textContent = response.overview.total_users || 0;
            document.getElementById('total-stores').textContent = response.overview.total_stores || 0;
            document.getElementById('total-devices').textContent = response.overview.total_devices_collected || 0;
            document.getElementById('total-purchases').textContent = response.overview.total_purchases || 0;
        }

        async function loadStoresStats() {
            const response = await apiRequest('/admin/statistics/stores');
            const container = document.getElementById('stores-stats');
            
            if (response.stores.length === 0) {
                container.innerHTML = '<p>–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö</p>';
                return;
            }

            container.innerHTML = `
                <table>
                    <thead>
                        <tr>
                            <th>–ù–∞–∑–≤–∞–Ω–∏–µ</th>
                            <th>–ì–æ—Ä–æ–¥</th>
                            <th>–ö–ª–∏–µ–Ω—Ç–æ–≤</th>
                            <th>–£—Å—Ç—Ä–æ–π—Å—Ç–≤</th>
                            <th>–ü–æ–∫—É–ø–æ–∫</th>
                            <th>–ë–∞–ª–ª–æ–≤ –≤—ã–¥–∞–Ω–æ</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${response.stores.map(store => `
                            <tr>
                                <td>${store.name}</td>
                                <td>${store.city}</td>
                                <td>${store.total_customers || 0}</td>
                                <td>${store.devices_collected || 0}</td>
                                <td>${store.purchases_count || 0}</td>
                                <td>${store.points_issued || 0}</td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;
        }

        async function loadGeographyStats() {
            const response = await apiRequest('/admin/statistics/geography');
            const container = document.getElementById('geography-stats');
            
            if (response.geography.length === 0) {
                container.innerHTML = '<p>–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö</p>';
                return;
            }

            container.innerHTML = `
                <table>
                    <thead>
                        <tr>
                            <th>–ì–æ—Ä–æ–¥</th>
                            <th>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π</th>
                            <th>–£—Å—Ç—Ä–æ–π—Å—Ç–≤ —Å–æ–±—Ä–∞–Ω–æ</th>
                            <th>–ü–æ–∫—É–ø–æ–∫</th>
                            <th>–ë–∞–ª–ª–æ–≤ –≤—ã–¥–∞–Ω–æ</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${response.geography.map(geo => `
                            <tr>
                                <td>${geo.city}</td>
                                <td>${geo.total_users || 0}</td>
                                <td>${geo.devices_collected || 0}</td>
                                <td>${geo.purchases_count || 0}</td>
                                <td>${geo.points_issued || 0}</td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;
        }

        async function exportReport() {
            try {
                const response = await apiRequest('/admin/export/report');
                
                // –°–æ–∑–¥–∞–Ω–∏–µ –∏ —Å–∫–∞—á–∏–≤–∞–Ω–∏–µ JSON —Ñ–∞–π–ª–∞
                const dataStr = JSON.stringify(response.report, null, 2);
                const dataBlob = new Blob([dataStr], {type: 'application/json'});
                const url = URL.createObjectURL(dataBlob);
                const link = document.createElement('a');
                link.href = url;
                link.download = `report_${new Date().toISOString().split('T')[0]}.json`;
                link.click();
                
                alert('‚úÖ –û—Ç—á—ë—Ç —ç–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω');
            } catch (error) {
                alert('‚ùå –û—à–∏–±–∫–∞ —ç–∫—Å–ø–æ—Ä—Ç–∞: ' + error.message);
            }
        }

        async function apiRequest(endpoint, method = 'GET', body = null) {
            const options = {
                method,
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${authToken}`
                }
            };

            if (body) {
                options.body = JSON.stringify(body);
            }

            const response = await fetch(`${API_URL}${endpoint}`, options);
            const data = await response.json();

            if (!data.success && data.error) {
                throw new Error(data.error);
            }

            return data;
        }

        function showError(message) {
            const container = document.getElementById('error-container');
            container.innerHTML = `<div class="error">${message}</div>`;
            setTimeout(() => {
                container.innerHTML = '';
            }, 5000);
        }
    </script>
</body>
</html>
